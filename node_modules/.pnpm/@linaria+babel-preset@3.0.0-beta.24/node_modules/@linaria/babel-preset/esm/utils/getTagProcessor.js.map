{"version":3,"file":"getTagProcessor.js","names":["readFileSync","basename","dirname","join","types","t","findUp","BaseProcessor","warn","collectExportsAndImports","getSource","isNotNull","last","arr","length","buildCodeFrameError","path","message","Error","findPackageJSON","pkgName","filename","pkgPath","require","resolve","paths","sync","cwd","er","code","undefined","definedTagsCache","Map","getDefinedTagsFromPackage","has","get","packageJSONPath","packageDir","packageJSON","JSON","parse","definedTags","linaria","tags","normalizedTags","Object","entries","reduce","acc","key","value","startsWith","set","isValidProcessorClass","module","constructor","getProcessor","packageName","tagName","processorPath","Processor","default","getBuilderForTemplate","imports","relatedImports","map","i","local","isIdentifier","isDescendant","binding","scope","getBinding","node","name","tagPath","referencePaths","find","p","filter","isExpression","imp","source","imported","proc","params","prev","current","parentPath","isSequenceExpression","expressions","isCallExpression","callee","args","push","arg","isMemberExpression","object","property","isPrivateName","getDisplayName","idx","state","displayName","parent","findParent","isObjectProperty","isJSXOpeningElement","isVariableDeclarator","toString","keyPath","isJSXIdentifier","id","file","opts","test","replace","counters","WeakMap","getNextIndex","counter","cache","getTagProcessor","options","root","isProgram","isFile","builder","processor","e"],"sources":["../../src/utils/getTagProcessor.ts"],"sourcesContent":["import { readFileSync } from 'fs';\nimport { basename, dirname, join } from 'path';\n\nimport { types as t } from '@babel/core';\nimport type { NodePath } from '@babel/traverse';\nimport type { Expression, TaggedTemplateExpression } from '@babel/types';\nimport findUp from 'find-up';\n\nimport BaseProcessor from '@linaria/core/processors/BaseProcessor';\nimport type { Params } from '@linaria/core/processors/types';\nimport { warn } from '@linaria/logger';\n\nimport type { StrictOptions } from '../types';\n\nimport type { IImport } from './collectExportsAndImports';\nimport collectExportsAndImports from './collectExportsAndImports';\nimport getSource from './getSource';\nimport isNotNull from './isNotNull';\n\ntype BuilderArgs = ConstructorParameters<typeof BaseProcessor> extends [\n  typeof t,\n  Params,\n  Expression,\n  ...infer T\n]\n  ? T\n  : never;\n\ntype Builder = (...args: BuilderArgs) => BaseProcessor;\n\ntype ProcessorClass = new (\n  ...args: ConstructorParameters<typeof BaseProcessor>\n) => BaseProcessor;\n\ninterface IState {\n  file: {\n    opts: {\n      root: string;\n      filename: string;\n    };\n  };\n}\n\nconst last = <T>(arr: T[]): T | undefined => arr[arr.length - 1];\n\nfunction buildCodeFrameError(path: NodePath, message: string): Error {\n  try {\n    return path.buildCodeFrameError(message);\n  } catch {\n    return new Error(message);\n  }\n}\n\nfunction findPackageJSON(pkgName: string, filename: string) {\n  try {\n    const pkgPath = require.resolve(pkgName, { paths: [dirname(filename)] });\n    return findUp.sync('package.json', { cwd: pkgPath });\n  } catch (er: unknown) {\n    if (\n      typeof er === 'object' &&\n      er !== null &&\n      (er as { code?: unknown }).code === 'MODULE_NOT_FOUND'\n    ) {\n      return undefined;\n    }\n\n    throw er;\n  }\n}\n\nconst definedTagsCache = new Map<string, Record<string, string> | undefined>();\nconst getDefinedTagsFromPackage = (\n  pkgName: string,\n  filename: string\n): Record<string, string> | undefined => {\n  if (definedTagsCache.has(pkgName)) {\n    return definedTagsCache.get(pkgName);\n  }\n\n  const packageJSONPath = findPackageJSON(pkgName, filename);\n  if (!packageJSONPath) {\n    return undefined;\n  }\n\n  const packageDir = dirname(packageJSONPath);\n  const packageJSON = JSON.parse(readFileSync(packageJSONPath, 'utf8'));\n  const definedTags: Record<string, string> | undefined =\n    packageJSON.linaria?.tags;\n\n  const normalizedTags = definedTags\n    ? Object.entries(definedTags).reduce(\n        (acc, [key, value]) => ({\n          ...acc,\n          [key]: value.startsWith('.')\n            ? join(packageDir, value)\n            : require.resolve(value, { paths: [packageDir] }),\n        }),\n        {} as Record<string, string>\n      )\n    : undefined;\n\n  definedTagsCache.set(pkgName, normalizedTags);\n\n  return normalizedTags;\n};\n\nfunction isValidProcessorClass(module: unknown): module is ProcessorClass {\n  return module instanceof BaseProcessor.constructor;\n}\n\nfunction getProcessor(\n  packageName: string,\n  tagName: string,\n  filename: string\n): ProcessorClass | null {\n  const definedTags = getDefinedTagsFromPackage(packageName, filename);\n  const processorPath = definedTags?.[tagName];\n  if (!processorPath) {\n    return null;\n  }\n\n  const Processor = require(processorPath).default;\n  if (!isValidProcessorClass(Processor)) {\n    return null;\n  }\n\n  return Processor;\n}\n\nfunction getBuilderForTemplate(\n  path: NodePath<TaggedTemplateExpression>,\n  imports: IImport[],\n  filename: string\n): Builder | null {\n  const relatedImports = imports\n    .map((i): [IImport, NodePath] | null => {\n      const { local } = i;\n\n      if (!local.isIdentifier()) {\n        if (local.isDescendant(path)) {\n          return [i, local];\n        }\n\n        return null;\n      }\n\n      const binding = local.scope.getBinding(local.node.name);\n\n      const tagPath = binding?.referencePaths.find((p) => p.isDescendant(path));\n\n      if (tagPath) {\n        return [i, tagPath];\n      }\n\n      return null;\n    })\n    .filter(isNotNull)\n    .filter((i) => i[1].isExpression());\n\n  if (relatedImports.length === 0) {\n    return null;\n  }\n\n  const [Processor, tagPath] =\n    relatedImports\n      .map(([imp, p]): [ProcessorClass | null, NodePath] => [\n        getProcessor(imp.source, imp.imported, filename),\n        p,\n      ])\n      .find(([proc]) => proc) ?? [];\n\n  if (!Processor || !tagPath) {\n    return null;\n  }\n\n  const params: Params = [];\n  let prev: NodePath | null = tagPath;\n  let current: NodePath | null = tagPath.parentPath;\n  while (current && current !== path) {\n    if (\n      current?.isSequenceExpression() &&\n      last(current.node.expressions) === prev.node\n    ) {\n      prev = current;\n      current = current.parentPath;\n      // eslint-disable-next-line no-continue\n      continue;\n    }\n\n    if (current?.isCallExpression() && current.node.callee === prev.node) {\n      const args = current.get('arguments');\n      params.push([\n        'call',\n        ...args.map(\n          (arg) => [getSource(arg), arg] as [string, NodePath<Expression>]\n        ),\n      ]);\n      prev = current;\n      current = current.parentPath;\n      // eslint-disable-next-line no-continue\n      continue;\n    }\n\n    if (current?.isMemberExpression() && current.node.object === prev.node) {\n      const property = current.get('property');\n      if (property.isPrivateName()) {\n        // eslint-disable-next-line no-continue\n        continue;\n      }\n\n      params.push(['member', property as NodePath<Expression>]);\n      prev = current;\n      current = current.parentPath;\n      // eslint-disable-next-line no-continue\n      continue;\n    }\n\n    throw buildCodeFrameError(path, 'Unexpected tag usage');\n  }\n\n  return (...args: BuilderArgs) =>\n    new Processor(t, params, (tagPath as NodePath<Expression>).node, ...args);\n}\n\nfunction getDisplayName(\n  path: NodePath<TaggedTemplateExpression>,\n  idx: number,\n  state: IState\n): string {\n  let displayName: string | undefined;\n\n  const parent = path.findParent(\n    (p) =>\n      p.isObjectProperty() ||\n      p.isJSXOpeningElement() ||\n      p.isVariableDeclarator()\n  );\n\n  if (parent) {\n    if (parent.isObjectProperty()) {\n      if ('name' in parent.node.key) {\n        displayName = parent.node.key.name;\n      } else if ('value' in parent.node.key) {\n        displayName = parent.node.key.value.toString();\n      } else {\n        const keyPath = parent.get('key');\n        displayName = getSource(keyPath);\n      }\n    } else if (parent.isJSXOpeningElement()) {\n      const name = parent.get('name');\n      if (name.isJSXIdentifier()) {\n        displayName = name.node.name;\n      }\n    } else if (parent.isVariableDeclarator()) {\n      const id = parent.get('id');\n      if (id.isIdentifier()) {\n        displayName = id.node.name;\n      }\n    }\n  }\n\n  if (!displayName) {\n    // Try to derive the path from the filename\n    displayName = basename(state.file.opts.filename);\n\n    if (/^index\\.[a-z\\d]+$/.test(displayName)) {\n      // If the file name is 'index', better to get name from parent folder\n      displayName = basename(dirname(state.file.opts.filename));\n    }\n\n    // Remove the file extension\n    displayName = displayName.replace(/\\.[a-z\\d]+$/, '');\n\n    if (displayName) {\n      displayName += idx;\n    } else {\n      throw new Error(\n        \"Couldn't determine a name for the component. Ensure that it's either:\\n\" +\n          '- Assigned to a variable\\n' +\n          '- Is an object property\\n' +\n          '- Is a prop in a JSX element\\n'\n      );\n    }\n  }\n\n  return displayName;\n}\n\nconst counters = new WeakMap<IState, number>();\nconst getNextIndex = (state: IState) => {\n  const counter = counters.get(state) ?? 0;\n  counters.set(state, counter + 1);\n  return counter;\n};\n\nconst cache = new WeakMap<\n  NodePath<TaggedTemplateExpression>,\n  BaseProcessor | null\n>();\n\nexport default function getTagProcessor(\n  path: NodePath<TaggedTemplateExpression>,\n  state: IState,\n  options: Pick<StrictOptions, 'classNameSlug' | 'displayName'>\n): BaseProcessor | null {\n  if (!cache.has(path)) {\n    // Increment the index of the style we're processing\n    // This is used for slug generation to prevent collision\n    // Also used for display name if it couldn't be determined\n    const idx = getNextIndex(state);\n\n    const root = path.findParent((p) => p.isProgram() || p.isFile());\n    if (!root) {\n      // How is this possible?\n      warn('get-tag-context', 'Could not find root node for template tag');\n      return null;\n    }\n\n    const { imports } = collectExportsAndImports(\n      root,\n      state.file.opts.filename\n    );\n    try {\n      const builder = getBuilderForTemplate(\n        path,\n        imports,\n        state.file.opts.filename\n      );\n      if (builder) {\n        const displayName = getDisplayName(path, idx, state);\n        const processor = builder(displayName, idx, options, state.file.opts);\n        cache.set(path, processor);\n      } else {\n        cache.set(path, null);\n      }\n    } catch (e) {\n      if (e instanceof Error) {\n        throw buildCodeFrameError(path, e.message);\n      }\n\n      throw e;\n    }\n  }\n\n  return cache.get(path) ?? null;\n}\n"],"mappings":"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"}