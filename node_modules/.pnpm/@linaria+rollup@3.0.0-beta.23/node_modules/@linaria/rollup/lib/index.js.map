{"version":3,"file":"index.js","names":["linaria","include","exclude","sourceMap","preprocessor","rest","filter","createFilter","cssLookup","config","name","configResolved","resolvedConfig","load","id","resolveId","importee","transform","code","result","filename","pluginOptions","cssText","slug","slugify","replace","cssSourceMapText","map","Buffer","from","toString","command","root","path","posix","relative","JSON","stringify"],"sources":["../src/index.ts"],"sourcesContent":["/**\n * This file contains a Rollup loader for Linaria.\n * It uses the transform.ts function to generate class names from source code,\n * returns transformed code without template literals and attaches generated source maps\n */\n\nimport path from 'path';\n\nimport { createFilter } from '@rollup/pluginutils';\n\nimport { transform, slugify } from '@linaria/babel-preset';\nimport type {\n  PluginOptions,\n  Preprocessor,\n  Result,\n} from '@linaria/babel-preset';\n\ntype RollupPluginOptions = {\n  include?: string | string[];\n  exclude?: string | string[];\n  sourceMap?: boolean;\n  preprocessor?: Preprocessor;\n} & Partial<PluginOptions>;\n\ntype ViteConfig = {\n  root: string;\n  command: 'serve' | 'build';\n};\n\nexport default function linaria({\n  include,\n  exclude,\n  sourceMap,\n  preprocessor,\n  ...rest\n}: RollupPluginOptions = {}) {\n  const filter = createFilter(include, exclude);\n  const cssLookup: { [key: string]: string } = {};\n  let config: ViteConfig;\n\n  return {\n    name: 'linaria',\n    configResolved(resolvedConfig: ViteConfig) {\n      config = resolvedConfig;\n    },\n    load(id: string) {\n      return cssLookup[id];\n    },\n    /* eslint-disable-next-line consistent-return */\n    resolveId(importee: string) {\n      if (importee in cssLookup) return importee;\n    },\n    transform(\n      code: string,\n      id: string\n    ): { code: string; map: Result['sourceMap'] } | undefined {\n      // Do not transform ignored and generated files\n      if (!filter(id) || id in cssLookup) return;\n\n      const result = transform(code, {\n        filename: id,\n        preprocessor,\n        pluginOptions: rest,\n      });\n\n      if (!result.cssText) return;\n\n      let { cssText } = result;\n\n      const slug = slugify(cssText);\n      const filename = `${id.replace(/\\.[jt]sx?$/, '')}_${slug}.css`;\n\n      if (sourceMap && result.cssSourceMapText) {\n        const map = Buffer.from(result.cssSourceMapText).toString('base64');\n        cssText += `/*# sourceMappingURL=data:application/json;base64,${map}*/`;\n      }\n\n      cssLookup[filename] = cssText;\n      if (config?.command === 'serve' && config?.root) {\n        cssLookup[`/${path.posix.relative(config.root, filename)}`] = cssText;\n      }\n\n      result.code += `\\nimport ${JSON.stringify(filename)};\\n`;\n\n      /* eslint-disable-next-line consistent-return */\n      return { code: result.code, map: result.sourceMap };\n    },\n  };\n}\n"],"mappings":";;;;;;;AAMA;;AAEA;;AAEA;;;;AAVA;AACA;AACA;AACA;AACA;AAyBe,SAASA,OAAT,CAAiB;EAC9BC,OAD8B;EAE9BC,OAF8B;EAG9BC,SAH8B;EAI9BC,YAJ8B;EAK9B,GAAGC;AAL2B,IAMP,EANV,EAMc;EAC3B,MAAMC,MAAM,GAAG,IAAAC,yBAAA,EAAaN,OAAb,EAAsBC,OAAtB,CAAf;EACA,MAAMM,SAAoC,GAAG,EAA7C;EACA,IAAIC,MAAJ;EAEA,OAAO;IACLC,IAAI,EAAE,SADD;;IAELC,cAAc,CAACC,cAAD,EAA6B;MACzCH,MAAM,GAAGG,cAAT;IACD,CAJI;;IAKLC,IAAI,CAACC,EAAD,EAAa;MACf,OAAON,SAAS,CAACM,EAAD,CAAhB;IACD,CAPI;;IAQL;IACAC,SAAS,CAACC,QAAD,EAAmB;MAC1B,IAAIA,QAAQ,IAAIR,SAAhB,EAA2B,OAAOQ,QAAP;IAC5B,CAXI;;IAYLC,SAAS,CACPC,IADO,EAEPJ,EAFO,EAGiD;MAAA;;MACxD;MACA,IAAI,CAACR,MAAM,CAACQ,EAAD,CAAP,IAAeA,EAAE,IAAIN,SAAzB,EAAoC;MAEpC,MAAMW,MAAM,GAAG,IAAAF,sBAAA,EAAUC,IAAV,EAAgB;QAC7BE,QAAQ,EAAEN,EADmB;QAE7BV,YAF6B;QAG7BiB,aAAa,EAAEhB;MAHc,CAAhB,CAAf;MAMA,IAAI,CAACc,MAAM,CAACG,OAAZ,EAAqB;MAErB,IAAI;QAAEA;MAAF,IAAcH,MAAlB;MAEA,MAAMI,IAAI,GAAG,IAAAC,oBAAA,EAAQF,OAAR,CAAb;MACA,MAAMF,QAAQ,GAAI,GAAEN,EAAE,CAACW,OAAH,CAAW,YAAX,EAAyB,EAAzB,CAA6B,IAAGF,IAAK,MAAzD;;MAEA,IAAIpB,SAAS,IAAIgB,MAAM,CAACO,gBAAxB,EAA0C;QACxC,MAAMC,GAAG,GAAGC,MAAM,CAACC,IAAP,CAAYV,MAAM,CAACO,gBAAnB,EAAqCI,QAArC,CAA8C,QAA9C,CAAZ;QACAR,OAAO,IAAK,qDAAoDK,GAAI,IAApE;MACD;;MAEDnB,SAAS,CAACY,QAAD,CAAT,GAAsBE,OAAtB;;MACA,IAAI,YAAAb,MAAM,UAAN,0CAAQsB,OAAR,MAAoB,OAApB,gBAA+BtB,MAA/B,qCAA+B,SAAQuB,IAA3C,EAAiD;QAC/CxB,SAAS,CAAE,IAAGyB,aAAA,CAAKC,KAAL,CAAWC,QAAX,CAAoB1B,MAAM,CAACuB,IAA3B,EAAiCZ,QAAjC,CAA2C,EAAhD,CAAT,GAA8DE,OAA9D;MACD;;MAEDH,MAAM,CAACD,IAAP,IAAgB,YAAWkB,IAAI,CAACC,SAAL,CAAejB,QAAf,CAAyB,KAApD;MAEA;;MACA,OAAO;QAAEF,IAAI,EAAEC,MAAM,CAACD,IAAf;QAAqBS,GAAG,EAAER,MAAM,CAAChB;MAAjC,CAAP;IACD;;EA9CI,CAAP;AAgDD"}